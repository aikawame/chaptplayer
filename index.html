<html>
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width,initial-scale=1" name="viewport">
  <title>ChaptPlayer</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet" href="app.css" />
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="app.js"></script>
</head>
<body>
<div id="player">
  <video
    id="video"
    ref="video"
    :src="url"
    @loadedmetadata="initializeMetadata"
    @timeupdate="syncCurrentTime"
  >
  </video>
  <div
    id="overlay"
    ref="overlay"
    :class="{ loaded: loaded }"
    :style="{ height: height }"
    @mouseenter="showOverlay"
    @mouseleave="hideOverlay"
  >
    <div id="play-area" v-if="visiblePlayArea">
      <button id="previous-button" @click="skipPrevious" v-if="chapters.length || 1">
        <i class="icon">skip_previous</i>
      </button>
      <button id="play-button" @click="togglePlay">
        <i class="icon">{{ paused ? 'play_arrow' : 'pause' }}</i>
      </button>
      <button id="next-button" @click="skipNext" v-if="chapters.length || 1">
        <i class="icon">skip_next</i>
      </button>
    </div>
    <div id="control-area" v-if="visibleControlArea">
      <div id="play-time">
        {{ currentTime|formatTime }}&nbsp;/&nbsp;{{ totalTime|formatTime }}
      </div>
      <div id="other-buttons">
        <button id="speed-button" @click="toggleSpeedMenu">
          <i class="icon">fast_forward</i>
          <span id="current-speed" v-if="currentSpeed !== 1">
            {{ currentSpeed }}x
          </span>
        </button>
        <button id="mute-button" @click="toggleMute">
          <i class="icon">{{ muted ? 'volume_off' : 'volume_up' }}</i>
        </button>
        <button id="fullscreen-button" @click="toggleFullscreen">
          <i class="icon">{{ fullscreened ? 'fullscreen_exit' : 'fullscreen' }}</i>
        </button>
      </div>
      <div id="seekbar-ranges">
        <label>
          <input
            id="seekbar-range"
            type="range"
            min="0"
            :max="totalTime"
            step="1"
            v-model="currentTime"
            @input="handleSeekbarInput"
          />
        </label>
      </div>
    </div>
    <div id="speed-menu" class="menu" v-if="visibleSpeedMenu">
      <label v-for="speed in speeds" @click="hideSpeedMenu">
        <input
          type="radio"
          name="speed"
          :value="speed"
          :checked="speed === currentSpeed"
          v-model="currentSpeed"
        />
        {{ speed|formatSpeed }}
      </label>
    </div>
  </div>
</div>
<script>
Vue.filter('formatTime', second => {
  // TODO: Optimize format by time.
  return new Date(second * 1000).toISOString().slice(11, -5);
});
Vue.filter('formatSpeed', speed => {
  return speed === 1 ? 'Normal' : speed;
});
new Vue({
  el: '#player',
  data() {
    return {
      loaded: false,
      url: '',
      binary: '',
      height: 0,
      totalTime: 0,
      speeds: [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2],
      chapters: [0],
      currentTime: 0,
      currentSpeed: 1,
      currentChapter: 0,
      paused: true,
      muted: false,
      fullscreened: false,
      visiblePlayArea: false,
      visibleControlArea: false,
      visibleSpeedMenu: false
    };
  },
  created() {
    this.url = getUrlParam('url');
  },
  mounted() {
    window.addEventListener('resize', this.syncHeight);
    window.addEventListener('keyup', this.handleKeypress);
  },
  destroyed() {
    window.removeEventListener('resize', this.syncHeight);
    window.removeEventListener('keyup', this.handleKeypress);
  },
  watch: {
    currentSpeed(value) {
      this.$refs.video.playbackRate = value;
    },
    paused(value) {
      if (value !== this.$refs.video.paused) {
        this.$refs.video.paused ? this.$refs.video.play() : this.$refs.video.pause();
      }
    },
    muted(value) {
      if (value !== this.$refs.video.muted) {
        this.$refs.video.muted = !this.$refs.video.muted;
      }
    }
  },
  methods: {
    initializeMetadata() {
      this.totalTime = this.$refs.video.duration;
      this.height = this.$refs.video.clientHeight;
      this.paused = false;
      this.loaded = true;
    },
    syncHeight() {
      this.height = this.$refs.video.clientHeight;
    },
    syncCurrentTime() {
      this.currentTime = this.$refs.video.currentTime;
    },
    togglePlay() {
      this.paused = !this.paused;
    },
    skipNext() {
      // TODO: Implement.
    },
    skipPrevious() {
      // TODO: Implement.
    },
    increaseSpeed() {
      const index = this.speeds.indexOf(this.currentSpeed);
      if (index < this.speeds.length - 1) {
        this.currentSpeed = this.speeds[index + 1];
      }
    },
    decreaseSpeed() {
      const index = this.speeds.indexOf(this.currentSpeed);
      if (index > 0) {
        this.currentSpeed = this.speeds[index - 1];
      }
    },
    toggleMute() {
      this.muted = !this.muted;
    },
    toggleFullscreen() {
      this.fullscreened = !this.fullscreened;
      // API can only be initiated by a user gesture.
      if (this.fullscreened && !document.webkitFullscreenElement) {
        this.$el.webkitRequestFullscreen();
      } else {
        document.webkitExitFullscreen();
      }
    },
    showOverlay() {
      this.visiblePlayArea = true;
      this.visibleControlArea = true;
      this.visibleSpeedMenu = false;
    },
    hideOverlay() {
      this.visiblePlayArea = false;
      this.visibleControlArea = false;
      this.visibleSpeedMenu = false;
    },
    toggleSpeedMenu() {
      this.visibleSpeedMenu = !this.visibleSpeedMenu;
    },
    hideSpeedMenu() {
      this.visibleSpeedMenu = false;
    },
    handleSeekbarInput(event) {
      this.$refs.video.currentTime = event.target.value;
    },
    handleKeypress(event) {
      switch (event.code) {
        case 'Space':
          this.togglePlay();
          break;
        case 'ArrowRight':
          this.skipNext();
          break;
        case 'ArrowLeft':
          this.skipPrevious();
          break;
        case 'ArrowUp':
          this.increaseSpeed();
          break;
        case 'ArrowDown':
          this.decreaseSpeed();
          break;
        case 'KeyM':
          if (event.altKey) this.toggleMute();
          break;
        case 'KeyF':
          if (event.altKey) this.toggleFullscreen();
          break;
      }
    }
  }
});
</script>
</body>
</html>
